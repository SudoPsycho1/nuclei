id: CVE-2023-38646

info:
  name: Metabase < 0.46.6.1 - Remote Code Execution (Detection)
  author: unknown
  severity: critical
  description: |
    Metabase open source before 0.46.6.1 and Metabase Enterprise before 1.46.6.1 allow attackers to execute arbitrary commands on the server, at the server's privilege level. Authentication is not required for exploitation. The other fixed versions are 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, and 1.43.7.2.
  reference:
    - https://www.metabase.com/blog/security-advisory
    - https://github.com/metabase/metabase/issues/32552
    - https://github.com/metabase/metabase/releases/tag/v0.46.6.1
    - https://mp.weixin.qq.com/s/ATFwFl-D8k9QfQfzKjZFDg
    - https://news.ycombinator.com/item?id=36812256
    - https://github.com/UltimateSec/ultimaste-nuclei-templates/tree/main/metabase
  classification:
    cve-id: CVE-2023-38646
    epss-score: 0.00048
  metadata:
    shodan-query: http.title:"Metabase"
    fofa-query: app="Metabase"
    verified: true
    max-request: 2
  tags: cve,cve2023,metabase,oss,rce

http:
  - raw:
      - |
        GET /api/session/properties HTTP/1.1
        Host: {{Hostname}}

      - |
        POST /api/setup/validate HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/json
        Content-Length: 244

        {"token":"{{token}}","details":{"details":{},"name":"{{randstr}}","engine":"mysql"}}

    extractors:
      - type: json
        part: body_1
        name: token
        json:
          - .["setup-token"]
        internal: true

    matchers:
      - type: word
        part: body_2
        words:
          - we couldn't connect to the database
